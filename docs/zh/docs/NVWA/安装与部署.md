# 安装与部署
本章介绍如何安装和部署NVWA。
<!-- TOC -->
- [安装与部署](#安装与部署)
  - [软硬件要求](#软硬件要求)
    - [硬件要求<a name="NVWA175931749114410"></a>](#硬件要求)
    - [软件要求<a name="NVWA19201810164619"></a>](#软件要求)
  - [环境准备](#环境准备)
  - [安装NVWA](#安装nvwa)
  - [部署NVWA](#部署nvwa)
    - [配置介绍](#配置介绍)
  - [使能NVWA](#使能nvwa)
<!-- /TOC -->

## 软硬件要求

### 硬件要求<a name="NVWA175931749114410"></a>

-   当前仅支持arm64架构

### 软件要求<a name="NVWA19201810164619"></a>

-   操作系统：openEuler 21.03

## 环境准备

-   安装openEuler系统，安装方法参考 《openEuler 21.03 安装指南》。

-   安装NVWA需要使用root权限。

## 安装NVWA

本章介绍NVWA的安装方法。

安装NVWA的操作步骤如下：

1.  挂载openEuler的iso文件

    ```
    # mount openEuler-21.03-aarch64-dvd.iso /mnt
    ```

2.  配置本地yum源

    ```
    # vim /etc/yum.repos.d/local.repo
    ```

    配置内容如下所示：

    ```
    [local]
    name=local
    baseurl=file:///mnt
    gpgcheck=1
    enabled=1
    ```

3.  将RPM数字签名的GPG公钥导入系统

    ```
    # rpm --import /mnt/RPM-GPG-KEY-openEuler
    ```


4. 安装NVWA

    ```
    # yum install nvwa -y
    ```

5.  验证是否安装成功。命令和回显如下表示安装成功。

    ```
    # rpm -qa | grep nvwa
    nvwa-xxx
    ```


## 部署NVWA

本章介绍NVWA的配置部署。

### 配置介绍

NVWA的配置文件位于/etc/nvwa，配置文件包括:
- nvwa-restore.yaml

    该配置文件用于指导NVWA在内核热升级过程中如何保存和恢复现场，具体配置如下:

    + pids

        pids用于指明nvwa热升级过程中需要保留和恢复的进程，此处的进程应该使用运行时二进制的文件名。需要注意的是，如果系统中存在多个重命名的进程，NVWA将会保存和恢复pid最小的进程。
    
    + services
    
        services用于指明nvwa热升级过程中需要保留和恢复的服务。与pids的区别在于，NVWA可以直接保存和恢复进程的状态，对于服务，NVWA则需要依赖systemd进行相关操作。此处的服务名称，应该使用systemd中使用的服务名称。
    
    + restore_net

        restore_net用于指明是否需要NVWA保存和恢复网络配置，如果网络配置有误，有可能导致恢复后网络不可用，因此默认关闭。

- nvwa-restore.yaml的配置示例
```
pids:
  - flock_test
services:
  - redis
  - sshd
restore_net: false
```

- nvwa-server.yaml

    该文件包含了NVWA运行过程中，需要使用到的配置信息，具体如下：
    
    + criu_dir

        用于指明NVWA在保存现场过程中，存储产生的信息文件夹路径。需要注意的是，这些信息可能会占用较大的磁盘空间。

    + criu_exe

        用于指明NVWA使用的criu可执行文件路径，除非是对criu进行调测，一般不建议修改。
    
    + kexec_exe

        用于指明NVWA使用的kexec可执行文件路径，除非是对kexec进行调测，一般不建议修改。
    
    + systemd_etc

        用于指明覆盖systemd配置过程中，使用到的文件夹路径。该路径由systemd决定，一般不需要修改。
    
    + log_dir

        存放NVWA产生的log信息，log模块当前未启用。NVWA日志信息的查看，参考其他章节<<使用方法>>

- nvwa-server.yaml的配置示例

```
criu_dir: /etc/nvwa/running/
criu_exe: /usr/sbin/criu
kexec_exe: /usr/sbin/kexec
systemd_etc: /etc/systemd/system/
log_dir: /etc/nvwa/log/
```

## 使能NVWA

NVWA的运行依赖配置文件，配置文件修改后应该重新运行NVWA程序。

安装成功后，可以通过systemd的相关命令来操作NVWA

+ 启动nvwa
  
    systemctl start nvwa
 
+ 查看nvwa日志

    service nvwa status

+ 更多用法参考systemd用法
