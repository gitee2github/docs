<!-- TOC -->

- [NVWA架构](#nvwa架构)
- [NVWA服务端用法](#nvwa服务端用法)
- [NVWA客户端用法](#nvwa客户端用法)
- [NVWA的使用限制](#nvwa的使用限制)
- [NVWA产生的日志信息](#nvwa产生的日志信息)
<!-- /TOC -->


## NVWA架构

NVWA分为客户端和服务端，通过端口进行通信和调用。实现上，客户端和服务端被编入一个二进制文件。用户需要通过systemd拉起NVWA服务进程，再通过nvwa程序发送命令，执行相应的流程。

## NVWA服务端用法

服务端支持以下用法:

+ nvwa --help

    打印帮助信息，打印的信息如下:
    ```
    Usage of nvwa:
    -ip string
            specify server ip (default "localhost")
    -mode int
            set this value to 1 to start a server
    -port string
            specify server port (default "3232")
    ```

ip和mode用于配置监听的网络端口，*当前客户端和服务端之间的通信并未加密*，因此仅适用于本地通信。

当前支持的模式有两种，mode指明为1，则只启动端口监听，等待命令; mode指明为2，则会受先执行现场的恢复，再启动端口监听，等待命令。

## NVWA客户端用法

+ nvwa help

    打印帮助信息，打印的信息如下:
    ```
    NAME:
    nvwa - a tool used for openEuler kernel update.

    USAGE:
    nvwa [global options] command [command options] [arguments...]

    VERSION:
    0.1

    COMMANDS:
    check    check kexec and criu version
    update   specify kernel version for nvwa to update
    restore  restore service
    init     init nvwa running environment
    help, h  Shows a list of commands or help for one command

    GLOBAL OPTIONS:
    --help, -h     show help (default: false)
    --version, -v  print the version (default: false)
    ```

+ nvwa check

    检查当前环境是否符合nvwa的运行条件

+ nvwa restore <service> <pid>

    恢复之前保存的服务现场环境，该命令主要用于systemd通过nvwa恢复现场，用户一般使用中不涉及

+ nvwa update <kernel version>

    热升级到内核某一版本，nvwa会去/boot目录下寻找内核镜像和ramfs，kernel的命名格式需为vmlinuz-<kernel version>, rootfs命名格式需为initramfs-<kernel version>.img

    需要注意的是，升级过程有可能会失败，如果失败，部分被dump的进程或者服务，将停止运行。

+ nvwa init

    清除nvwa产生的现场信息以及对systemd的配置修改

## NVWA的使用限制

1. 对于需要通过nvwa保存的service，其配置中需要设置标准输出(StandardOutput)和错误输出(StandardError)，以redis为例:

    ```
    [Unit]
    Description=Redis persistent key-value database
    After=network.target
    [Service]
    ExecStart=/usr/bin/redis-server /etc/redis.conf --supervised systemd
    Type=notify
    User=redis
    Group=redis
    RuntimeDirectory=redis
    RuntimeDirectoryMode=0755
    StandardOutput=file:/root/log1.log
    StandardError=file:/root/log2.log
    [Install]
    WantedBy=multi-user.target
    ```

2. cmdline中需包含以下参数:

    ```
    quickkexec=128M
    ```

    openEuler21.03的cmdline配置文件位于/boot/efi/EFI/openEuler/grub.cfg

## NVWA产生的日志信息

nvwa产生的日志分为三部分:

+ 服务端产生的日志

    通过service nvwa status查看

+ 客户端产生的日志

    直接输出到当前窗口

+ 保留现场过程中产生的日志

    日志位于criu_dir指定的路径对应命名的进程/服务文件夹中

