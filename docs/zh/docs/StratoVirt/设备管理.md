# 设备管理

[[toc]]

## 概述

StratoVirt可以管理虚拟机的设备，如balloon，iothread，磁盘QoS等，本节将介绍如何管理这些设备。



## 配置iothread

### 简介

当StratoVirt启动了带iothread配置的虚拟机后，会在主机上启动独立于主线程的单独线程，这些单独线程可以用来处理设备的IO请求，一方面提升设备的IO性能，另一方面降低对管理面消息处理的影响。

### 注意事项

- 支持配置最多8个iothread线程
- 只支持磁盘和网卡配置iothread属性
- iothread线程会占用主机CPU资源，在虚拟机内部大IO压力情况下，单个iothread占用的CPU资源取决于磁盘的访问速度，例如普通的SATA盘会占用20%以内CPU资源。
- 不支持在热插设备时配置iothread。
- 一个设备最多只能配置一个iothread，多个设备可以配置同一个iothread。



### 配置iothread线程

用法：

```
-iothread id=iothread1 -iothread id=iothread2
```

参数：

- id：用于标识此iothread线程，该id可以被设置到磁盘或网卡的iothread属性。当启动参数配置了iothread线程信息，虚拟机启动后会在主机上启动相应id名的线程。



### 配置磁盘或网卡的iothread属性

用法：

```
# 磁盘
-drive xxx,iothread=iothread1
# 网卡
-netdev xxx,iothread=iothread2
```

参数：

- iothread：设置成iothread线程的id，指明处理本设备IO的线程。
- xxx: 表示磁盘或者网卡的其他配置



## 配置磁盘QoS

### 简介

QoS（Quality of Service）是服务质量的意思。在云场景中，单主机内会启动多台虚拟机，由于同主机的磁盘访问总带宽有限，当某台虚拟机对磁盘访问压力大时，其他虚拟机的访问带宽会被挤占，从而导致其他虚拟机的IO受到影响。为了消除影响，可以为虚拟机配置QoS属性，限制它们对磁盘访问的速率，从而降低对彼此的影响。



### 注意事项

- 当前QoS支持配置磁盘的iops。
- iops的设定范围是[0, 1000000]，0为不限速；实际iops不会超过设定值，并且不会超过后端磁盘实际性能的上限。
- 只能限制平均iops，无法限速瞬时的突发流量。
- 不支持在热插设备时配置QoS.


### 配置方式

用法：

```
-drive xxx,iops=200
```

参数：

- iops：当配置了iops后，本磁盘在虚拟机内部的IO下发速度，不会超过此配置值。
- xxx: 表示磁盘的其他设置。





## 配置内存弹性

### 简介

在虚拟机运行过程中,由虚拟机里的balloon驱动来动态占用或释放内存,从而动态改变这台虚拟机当前可用内存，达到内存弹性的效果。Balloon驱动占用的内存是从虚拟机可用内存中争抢来的,为虚拟机不可用,宿主机可用的内存。因为在实际环境中，一个单板上运行的多台虚拟机通常不会都处于内存利用率很高的场景，所以balloon技术的引入，可以在某些虚拟机负载较轻时，通过balloon驱动从这些虚拟机中抽取出空闲内存归还给宿主机，然后宿主机可以将回收的内存给其他虚拟机使用，从而实现内存资源的基本伸缩能力。



### 注意事项

- 启用balloon前须确保guest和host的page size相同。
- guest内核须开启balloon特性支持。
- 开启内存弹性时，有可能造成虚拟机内部轻微卡顿、内存性能下降。



### 互斥特性

- 大页内存互斥。
- 在x86下，由于中断数量有限，所以balloon设备和其他virtio的数量（默认使用6个block设备，2个net设备和1个串口设备）总和不得超过11个。



### 规格

- 每个VM只能配置1个balloon设备。



### 配置方式

- 命令行

```
-balloon deflate-on-oom=true
```

- json文件

  ```json
  {  
      "balloon": {
          "deflate_on_oom": true  
      },
      ...
  }
  ```



### 使用方式：

![img](./figures/zh-cn_image_0218587436.png) 

Balloon的使用是通过qmp命令来调用。使用QMP前，请参见”管理虚拟机生命周期”使用QMP连接到虚拟机。qmp命令使用如下：

**用法：**

```
{"execute": "balloon", "arguments": {"value": "2147483648‬"}}
```

**参数：**

- value： 想要设置的guest内存大小值，单位为字节。如果该值大于虚拟机启动时配置的内存值，则以启动时配置的内存值为准。

**示例：**

启动时配置的内存大小为4GiB，在虚拟机内部通过free命令查询虚拟机空闲内存大于2GiB，那么可以通过qmp命令设置guest内存大小为2147483648字节。

```
<- {"execute": "balloon", "arguments": {"value": 2147483648‬ }}
-> {"return": {}}
```

查询虚拟机的当前实际内存：

```
<- {"execute": "query-balloon"}
-> {"return":{"actual":2147483648}}
```



![img](./figures/zh-cn_image_0218587436.png) 

1. deflate-on-oom的取值为bool类型，表示是否开启auto deflate特性。开启时，如果balloon已经回收部分内存，当guest需要内存时，balloon设备会自动放气，归还内存给guest。不开启则不会自动归还。
2. 使用qmp命令回收虚拟机内存时，应确保回收后虚拟机仍然有足够的内存来保持最基本的运行。否则可能会出现一些操作超时，以及导致虚拟机内部无法申请到空闲内存等现象。
3. 如果虚拟机内部开启内存大页，balloon也不能回收内存。



![img](./figures/zh-cn_image_to_know.png) 

- deflate-on-oom=false时，当Guest中内存不足时，balloon不会自动放气并归还内存，可能会引起Guest内部OOM，进程被Kill，甚至虚拟机无法正常运行。